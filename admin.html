<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - Prince Alex Digital</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut,
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      onSnapshot,
      collection,
      addDoc,
      deleteDoc,
      updateDoc,
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL,
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCW0BqYOirnrPRkgvSvtSjK2-OGVTa71uQ",
      authDomain: "princealexdigital-4848c.firebaseapp.com",
      projectId: "princealexdigital-4848c",
      storageBucket: "princealexdigital-4848c.appspot.com",
      messagingSenderId: "1316427677",
      appId: "1:1316427677:web:21bdffbf2095d1d5064174"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);
    const appId = "default-app-id";

    const loginForm = document.getElementById("login-form");
    const dashboard = document.getElementById("dashboard");
    const loginPage = document.getElementById("login-page");
    const logoutBtn = document.getElementById("logout-btn");

    // Custom alert/message box function
    function showMessage(message, type = 'info') {
      const messageBox = document.getElementById('message-box');
      const messageText = document.getElementById('message-text');
      const closeMessage = document.getElementById('close-message');

      messageText.textContent = message;
      messageBox.className = `fixed top-4 right-4 p-4 rounded shadow-lg z-50 ${type === 'error' ? 'bg-red-500' : 'bg-blue-500'} text-white`;
      messageBox.classList.remove('hidden');

      closeMessage.onclick = () => {
        messageBox.classList.add('hidden');
      };

      setTimeout(() => {
        messageBox.classList.add('hidden');
      }, 5000); // Hide after 5 seconds
    }

    loginForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const email = loginForm.email.value;
      const password = loginForm.password.value;

      signInWithEmailAndPassword(auth, email, password)
        .then(() => {
          loginPage.classList.add("hidden");
          dashboard.classList.remove("hidden");
          showMessage("Login successful!", "info");
        })
        .catch((error) => {
          showMessage("Login failed: " + error.message, "error");
        });
    });

    logoutBtn.addEventListener("click", () => {
      signOut(auth).then(() => {
        dashboard.classList.add("hidden");
        loginPage.classList.remove("hidden");
        showMessage("Logged out successfully!", "info");
      });
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginPage.classList.add("hidden");
        dashboard.classList.remove("hidden");
        loadStats();
        loadPortfolio();
        loadTestimonials();
        loadMessages();
      } else {
        dashboard.classList.add("hidden");
        loginPage.classList.remove("hidden");
      }
    });

    // Stats update
    const statForm = document.getElementById("stats-form");
    statForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const statsRef = doc(db, `artifacts/${appId}/public/data/statistics/currentStats`);
      try {
        await setDoc(statsRef, {
          projects: statForm.projects.value,
          clients: statForm.clients.value,
          successRate: statForm.success.value,
        });
        showMessage("Statistics updated!", "info");
      } catch (error) {
        showMessage("Failed to update statistics: " + error.message, "error");
      }
    });

    function loadStats() {
      const statsRef = doc(db, `artifacts/${appId}/public/data/statistics/currentStats`);
      onSnapshot(statsRef, (docSnap) => {
        if (docSnap.exists()) {
          const data = docSnap.data();
          statForm.projects.value = data.projects || "";
          statForm.clients.value = data.clients || "";
          statForm.success.value = data.successRate || "";
        }
      });
    }

    // Portfolio
    const portfolioList = document.getElementById("portfolio-list");
    const portfolioForm = document.getElementById("portfolio-form");
    const portfolioImageInput = document.getElementById("portfolio-image-upload");
    const portfolioAddButton = portfolioForm.querySelector('button[type="submit"]');
    const imageUploadStatus = document.getElementById("image-upload-status");
    const imageUploadSpinner = document.getElementById("image-upload-spinner"); // Get the spinner element

    let uploadedImageUrl = ""; // To store the URL after upload

    // Disable the add project button by default
    portfolioAddButton.disabled = true;
    portfolioAddButton.classList.add("opacity-50", "cursor-not-allowed");

    portfolioImageInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (file) {
        imageUploadStatus.textContent = "Uploading image...";
        imageUploadStatus.classList.remove("hidden", "text-red-600", "text-green-600");
        imageUploadSpinner.classList.remove("hidden"); // Show spinner
        portfolioAddButton.disabled = true; // Disable button during upload
        portfolioAddButton.classList.add("opacity-50", "cursor-not-allowed");

        const storageRef = ref(storage, `portfolio-images/${file.name}`);
        try {
          await uploadBytes(storageRef, file);
          uploadedImageUrl = await getDownloadURL(storageRef);
          imageUploadStatus.textContent = "Image uploaded successfully!";
          imageUploadStatus.classList.add("text-green-600");
          portfolioAddButton.disabled = false; // Enable button after successful upload
          portfolioAddButton.classList.remove("opacity-50", "cursor-not-allowed");
        } catch (error) {
          imageUploadStatus.textContent = "Image upload failed: " + error.message;
          imageUploadStatus.classList.add("text-red-600");
          uploadedImageUrl = ""; // Clear URL on failure
          portfolioAddButton.disabled = true; // Keep button disabled on failure
          portfolioAddButton.classList.add("opacity-50", "cursor-not-allowed");
        } finally {
          imageUploadSpinner.classList.add("hidden"); // Hide spinner
        }
      } else {
        uploadedImageUrl = "";
        imageUploadStatus.textContent = "";
        imageUploadStatus.classList.add("hidden");
        imageUploadSpinner.classList.add("hidden"); // Hide spinner
        portfolioAddButton.disabled = true; // Disable if no file selected
        portfolioAddButton.classList.add("opacity-50", "cursor-not-allowed");
      }
    });

    portfolioForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!uploadedImageUrl) {
        showMessage("Please upload an image first.", "error");
        return;
      }
      try {
        await addDoc(collection(db, `artifacts/${appId}/public/data/portfolio`), {
          title: portfolioForm.title.value,
          description: portfolioForm.description.value,
          link: portfolioForm.link.value,
          imageUrl: uploadedImageUrl,
          linkText: portfolioForm.linkText.value || "View Project",
        });
        showMessage("Project added successfully!", "info");
        portfolioForm.reset();
        portfolioImageInput.value = ""; // Clear the file input
        uploadedImageUrl = ""; // Reset the URL
        imageUploadStatus.textContent = ""; // Clear status message
        imageUploadStatus.classList.add("hidden");
        imageUploadSpinner.classList.add("hidden"); // Hide spinner
        portfolioAddButton.disabled = true; // Disable button again after submission
        portfolioAddButton.classList.add("opacity-50", "cursor-not-allowed");
      } catch (error) {
        showMessage("Failed to add project: " + error.message, "error");
      }
    });

    function loadPortfolio() {
      const portfolioRef = collection(db, `artifacts/${appId}/public/data/portfolio`);
      onSnapshot(portfolioRef, (snapshot) => {
        portfolioList.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          portfolioList.innerHTML += `
            <div class="border p-4 rounded shadow mb-2">
              <p><strong>${data.title}</strong></p>
              <p>${data.description}</p>
              ${data.imageUrl ? `<img src="${data.imageUrl}" alt="${data.title}" class="w-full h-32 object-cover mt-2 mb-2 rounded">` : ''}
              <a href="${data.link}" target="_blank" class="text-blue-600 hover:underline">${data.linkText}</a>
              <button onclick="deletePortfolio('${docSnap.id}')" class="text-red-600 text-sm mt-2 block">Delete</button>
            </div>
          `;
        });
      });
    }

    window.deletePortfolio = async (id) => {
      try {
        await deleteDoc(doc(db, `artifacts/${appId}/public/data/portfolio`, id));
        showMessage("Project deleted successfully!", "info");
      } catch (error) {
        showMessage("Failed to delete project: " + error.message, "error");
      }
    };

    // Testimonials
    const testimonialForm = document.getElementById("testimonial-form");
    const testimonialList = document.getElementById("testimonial-list");

    testimonialForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      try {
        await addDoc(collection(db, `artifacts/${appId}/public/data/testimonials`), {
          quote: testimonialForm.quote.value,
          author: testimonialForm.author.value,
          company: testimonialForm.company.value,
        });
        showMessage("Testimonial added successfully!", "info");
        testimonialForm.reset();
      } catch (error) {
        showMessage("Failed to add testimonial: " + error.message, "error");
      }
    });

    function loadTestimonials() {
      const ref = collection(db, `artifacts/${appId}/public/data/testimonials`);
      onSnapshot(ref, (snapshot) => {
        testimonialList.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          testimonialList.innerHTML += `
            <div class="border p-4 rounded shadow mb-2">
              <p>"${data.quote}" - ${data.author}, ${data.company}</p>
              <button onclick="deleteTestimonial('${docSnap.id}')" class="text-red-600 text-sm mt-2">Delete</button>
            </div>
          `;
        });
      });
    }

    window.deleteTestimonial = async (id) => {
      try {
        await deleteDoc(doc(db, `artifacts/${appId}/public/data/testimonials`, id));
        showMessage("Testimonial deleted successfully!", "info");
      } catch (error) {
        showMessage("Failed to delete testimonial: " + error.message, "error");
      }
    };

    // Messages
    function loadMessages() {
      const ref = collection(db, `artifacts/${appId}/public/data/messages`);
      const container = document.getElementById("messages-list");
      onSnapshot(ref, (snapshot) => {
        container.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const m = docSnap.data();
          container.innerHTML += `
            <div class="border p-4 rounded shadow mb-2">
              <p><strong>${m.fullName}</strong> (${m.emailAddress})</p>
              <p>${m.projectDetails}</p>
            </div>
          `;
        });
      });
    }
  </script>
</head>
<body class="bg-gray-100 font-sans">

  <!-- Custom Message Box -->
  <div id="message-box" class="hidden">
    <span id="message-text"></span>
    <button id="close-message" class="ml-4 font-bold">&times;</button>
  </div>

  <div id="login-page" class="flex justify-center items-center h-screen">
    <form id="login-form" class="bg-white p-8 rounded shadow-md w-full max-w-sm">
      <h2 class="text-2xl font-bold text-center mb-6">Admin Login</h2>
      <input name="email" type="email" placeholder="Email" required class="w-full mb-4 p-2 border rounded" />
      <input name="password" type="password" placeholder="Password" required class="w-full mb-6 p-2 border rounded" />
      <button type="submit" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Login</button>
    </form>
  </div>

  <div id="dashboard" class="hidden p-6 space-y-10">
    <div class="flex justify-between items-center">
      <h1 class="text-3xl font-bold">Admin Dashboard</h1>
      <button id="logout-btn" class="bg-red-500 text-white px-4 py-2 rounded">Logout</button>
    </div>

    <section>
      <h2 class="text-xl font-semibold mb-2">Update Website Statistics</h2>
      <form id="stats-form" class="grid gap-4 max-w-md">
        <input name="projects" placeholder="Projects Delivered" required class="p-2 border rounded" />
        <input name="clients" placeholder="Happy Clients" required class="p-2 border rounded" />
        <input name="success" placeholder="Success Rate" required class="p-2 border rounded" />
        <button class="bg-blue-600 text-white p-2 rounded">Update Stats</button>
      </form>
    </section>

    <section>
      <h2 class="text-xl font-semibold mb-2">Manage Portfolio Projects</h2>
      <form id="portfolio-form" class="grid gap-4 max-w-md mb-4">
        <input name="title" placeholder="Project Title" required class="p-2 border rounded" />
        <input name="description" placeholder="Project Description" required class="p-2 border rounded" />
        <div class="flex items-center space-x-2">
          <input type="file" id="portfolio-image-upload" accept="image/*" class="p-2 border rounded flex-grow" />
          <!-- Spinner for image upload -->
          <div id="image-upload-spinner" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-gray-900"></div>
        </div>
        <p id="image-upload-status" class="text-sm mt-1 hidden"></p> <!-- Status message for image upload -->
        <input name="link" placeholder="Project Link" required class="p-2 border rounded" />
        <input name="linkText" placeholder="Link Text (optional)" class="p-2 border rounded" />
        <button type="submit" class="bg-green-600 text-white p-2 rounded">Add Project</button>
      </form>
      <div id="portfolio-list"></div>
    </section>

    <section>
      <h2 class="text-xl font-semibold mb-2">Manage Client Testimonials</h2>
      <form id="testimonial-form" class="grid gap-4 max-w-md mb-4">
        <textarea name="quote" placeholder="Client Quote" required class="p-2 border rounded"></textarea>
        <input name="author" placeholder="Author" required class="p-2 border rounded" />
        <input name="company" placeholder="Company" required class="p-2 border rounded" />
        <button class="bg-green-600 text-white p-2 rounded">Add Testimonial</button>
      </form>
      <div id="testimonial-list"></div>
    </section>

    <section>
      <h2 class="text-xl font-semibold mb-2">Received Contact Messages</h2>
      <div id="messages-list"></div>
    </section>
  </div>
</body>
</html>
