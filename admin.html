<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - Prince Alex Digital</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut,
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      onSnapshot,
      collection,
      addDoc,
      deleteDoc,
      updateDoc,
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL,
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js"; // Import Firebase Storage

    const firebaseConfig = {
      apiKey: "AIzaSyCW0BqYOirnrPRkgvSvtSjK2-OGVTa71uQ",
      authDomain: "princealexdigital-4848c.firebaseapp.com",
      projectId: "princealexdigital-4848c",
      storageBucket: "princealexdigital-4848c.appspot.com", // Make sure this is present
      messagingSenderId: "1316427677",
      appId: "1:1316427677:web:21bdffbf2095d1d5064174"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app); // Initialize Firebase Storage
    const appId = "default-app-id";

    const loginForm = document.getElementById("login-form");
    const dashboard = document.getElementById("dashboard");
    const loginPage = document.getElementById("login-page");
    const logoutBtn = document.getElementById("logout-btn");

    loginForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const email = loginForm.email.value;
      const password = loginForm.password.value;

      signInWithEmailAndPassword(auth, email, password)
        .then(() => {
          loginPage.classList.add("hidden");
          dashboard.classList.remove("hidden");
        })
        .catch((error) => {
          alert("Login failed: " + error.message);
        });
    });

    logoutBtn.addEventListener("click", () => {
      signOut(auth).then(() => {
        dashboard.classList.add("hidden");
        loginPage.classList.remove("hidden");
      });
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginPage.classList.add("hidden");
        dashboard.classList.remove("hidden");
        loadStats();
        loadPortfolio();
        loadTestimonials();
        loadMessages();
      } else {
        dashboard.classList.add("hidden");
        loginPage.classList.remove("hidden");
      }
    });

    // Stats update
    const statForm = document.getElementById("stats-form");
    statForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const statsRef = doc(db, `artifacts/${appId}/public/data/statistics/currentStats`);
      await setDoc(statsRef, {
        projects: statForm.projects.value,
        clients: statForm.clients.value,
        successRate: statForm.success.value,
      });
      alert("Statistics updated!");
    });

    function loadStats() {
      const statsRef = doc(db, `artifacts/${appId}/public/data/statistics/currentStats`);
      onSnapshot(statsRef, (docSnap) => {
        if (docSnap.exists()) {
          const data = docSnap.data();
          statForm.projects.value = data.projects || "";
          statForm.clients.value = data.clients || "";
          statForm.success.value = data.successRate || "";
        }
      });
    }

    // Portfolio
    const portfolioList = document.getElementById("portfolio-list");
    const portfolioForm = document.getElementById("portfolio-form");
    const portfolioImageInput = document.getElementById("portfolio-image-upload"); // New image input
    let uploadedImageUrl = ""; // To store the URL after upload

    portfolioImageInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (file) {
        const storageRef = ref(storage, `portfolio-images/${file.name}`);
        try {
          await uploadBytes(storageRef, file);
          uploadedImageUrl = await getDownloadURL(storageRef);
          alert("Image uploaded successfully!");
        } catch (error) {
          alert("Image upload failed: " + error.message);
        }
      }
    });

    portfolioForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!uploadedImageUrl) {
        alert("Please upload an image first.");
        return;
      }
      await addDoc(collection(db, `artifacts/${appId}/public/data/portfolio`), {
        title: portfolioForm.title.value,
        description: portfolioForm.description.value,
        link: portfolioForm.link.value,
        imageUrl: uploadedImageUrl, // Use the uploaded URL
        linkText: portfolioForm.linkText.value || "View Project",
      });
      portfolioForm.reset();
      portfolioImageInput.value = ""; // Clear the file input
      uploadedImageUrl = ""; // Reset the URL
    });

    function loadPortfolio() {
      const portfolioRef = collection(db, `artifacts/${appId}/public/data/portfolio`);
      onSnapshot(portfolioRef, (snapshot) => {
        portfolioList.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          portfolioList.innerHTML += `
            <div class="border p-4 rounded shadow mb-2">
              <p><strong>${data.title}</strong></p>
              <p>${data.description}</p>
              ${data.imageUrl ? `<img src="${data.imageUrl}" alt="${data.title}" class="w-full h-32 object-cover mt-2 mb-2">` : ''}
              <a href="${data.link}" target="_blank" class="text-blue-600 hover:underline">${data.linkText}</a>
              <button onclick="deletePortfolio('${docSnap.id}')" class="text-red-600 text-sm mt-2 block">Delete</button>
            </div>
          `;
        });
      });
    }

    window.deletePortfolio = async (id) => {
      await deleteDoc(doc(db, `artifacts/${appId}/public/data/portfolio`, id));
    };

    // Testimonials
    const testimonialForm = document.getElementById("testimonial-form");
    const testimonialList = document.getElementById("testimonial-list");

    testimonialForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      await addDoc(collection(db, `artifacts/${appId}/public/data/testimonials`), {
        quote: testimonialForm.quote.value,
        author: testimonialForm.author.value,
        company: testimonialForm.company.value,
      });
      testimonialForm.reset();
    });

    function loadTestimonials() {
      const ref = collection(db, `artifacts/${appId}/public/data/testimonials`);
      onSnapshot(ref, (snapshot) => {
        testimonialList.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          testimonialList.innerHTML += `
            <div class="border p-4 rounded shadow mb-2">
              <p>"${data.quote}" - ${data.author}, ${data.company}</p>
              <button onclick="deleteTestimonial('${docSnap.id}')" class="text-red-600 text-sm mt-2">Delete</button>
            </div>
          `;
        });
      });
    }

    window.deleteTestimonial = async (id) => {
      await deleteDoc(doc(db, `artifacts/${appId}/public/data/testimonials`, id));
    };

    // Messages
    function loadMessages() {
      const ref = collection(db, `artifacts/${appId}/public/data/messages`);
      const container = document.getElementById("messages-list");
      onSnapshot(ref, (snapshot) => {
        container.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const m = docSnap.data();
          container.innerHTML += `
            <div class="border p-4 rounded shadow mb-2">
              <p><strong>${m.fullName}</strong> (${m.emailAddress})</p>
              <p>${m.projectDetails}</p>
            </div>
          `;
        });
      });
    }
  </script>
</head>
<body class="bg-gray-100 font-sans">

  <div id="login-page" class="flex justify-center items-center h-screen">
    <form id="login-form" class="bg-white p-8 rounded shadow-md w-full max-w-sm">
      <h2 class="text-2xl font-bold text-center mb-6">Admin Login</h2>
      <input name="email" type="email" placeholder="Email" required class="w-full mb-4 p-2 border rounded" />
      <input name="password" type="password" placeholder="Password" required class="w-full mb-6 p-2 border rounded" />
      <button type="submit" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Login</button>
    </form>
  </div>

  <div id="dashboard" class="hidden p-6 space-y-10">
    <div class="flex justify-between items-center">
      <h1 class="text-3xl font-bold">Admin Dashboard</h1>
      <button id="logout-btn" class="bg-red-500 text-white px-4 py-2 rounded">Logout</button>
    </div>

    <section>
      <h2 class="text-xl font-semibold mb-2">Update Website Statistics</h2>
      <form id="stats-form" class="grid gap-4 max-w-md">
        <input name="projects" placeholder="Projects Delivered" required class="p-2 border rounded" />
        <input name="clients" placeholder="Happy Clients" required class="p-2 border rounded" />
        <input name="success" placeholder="Success Rate" required class="p-2 border rounded" />
        <button class="bg-blue-600 text-white p-2 rounded">Update Stats</button>
      </form>
    </section>

    <section>
      <h2 class="text-xl font-semibold mb-2">Manage Portfolio Projects</h2>
      <form id="portfolio-form" class="grid gap-4 max-w-md mb-4">
        <input name="title" placeholder="Project Title" required class="p-2 border rounded" />
        <input name="description" placeholder="Project Description" required class="p-2 border rounded" />
        <input type="file" id="portfolio-image-upload" accept="image/*" class="p-2 border rounded" /> <input name="link" placeholder="Project Link" required class="p-2 border rounded" />
        <input name="linkText" placeholder="Link Text (optional)" class="p-2 border rounded" />
        <button type="submit" class="bg-green-600 text-white p-2 rounded">Add Project</button>
      </form>
      <div id="portfolio-list"></div>
    </section>

    <section>
      <h2 class="text-xl font-semibold mb-2">Manage Client Testimonials</h2>
      <form id="testimonial-form" class="grid gap-4 max-w-md mb-4">
        <textarea name="quote" placeholder="Client Quote" required class="p-2 border rounded"></textarea>
        <input name="author" placeholder="Author" required class="p-2 border rounded" />
        <input name="company" placeholder="Company" required class="p-2 border rounded" />
        <button class="bg-green-600 text-white p-2 rounded">Add Testimonial</button>
      </form>
      <div id="testimonial-list"></div>
    </section>

    <section>
      <h2 class="text-xl font-semibold mb-2">Received Contact Messages</h2>
      <div id="messages-list"></div>
    </section>
  </div>
</body>
</html>
